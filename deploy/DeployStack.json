{
    "schemaVersion": "2.2",
    "description": "Deploy a docker stack to a cluster",
    "parameters": {
      "stackfile":{
        "type":"String",
        "description":"(Required) The location of the stack file to run"
      },
      "configfile":{
        "type":"String",
        "description":"(Required) The configuration for the reverse proxy server"
      },
      "image":{
        "type":"String",
        "description":"(Required) The image to deploy"
      }
    },
    "mainSteps" : [
        {
            "action":"aws:runShellScript",
            "name":"FetchStackFile",
            "inputs":{
                "runCommand": [
                    "wget -O /tmp/services.yml {{ stackfile }}"
                ]
            }
        },
        {
            "action":"aws:runShellScript",
            "name":"FetchConfigFile",
            "inputs":{
                "runCommand": [
                    "wget -O /tmp/default.conf {{ configfile }}"
                ]
            }
        },
        {
            "action":"aws:runShellScript",
            "name":"PullImage",
            "inputs":{
                "runCommand": [
                    "docker pull {{ image }}"
                ]
            }
        },
        {
            "action":"aws:runShellScript",
            "name":"PullVisualizerImage",
            "inputs":{
                "runCommand": [
                    "docker pull dockersamples/visualizer:latest"
                ]
            }
        },
        {
            "action":"aws:runShellScript",
            "name":"DeployStacks",
            "inputs":{
                "workingDirectory": "/tmp",
                "runCommand": [
                    "docker stack deploy -c ./services.yml homepagecore --with-registry-auth"
                ]
            }
        }
    ]
}